<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tareitaz</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #1e1e1e; 
      color: #e0e0e0; 
      padding: 2rem; 
    }
    .task { 
      padding: 0.75rem 1rem; 
      cursor: move;
      position: relative;
      margin-bottom: 0.75rem;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-left: 3px solid transparent;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .task:hover { 
      background: #2a2a2a;
      transform: translateX(4px);
    }
    .task.ui-sortable-helper {
      background: #2a2a2a;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .done { 
      color: #4ade80; 
      border-left-color: #4ade80;
    }
    .cancelled { 
      color: #f87171; 
      border-left-color: #f87171;
    }
    .started { 
      color: #fbbf24; 
      border-left-color: #fbbf24;
    }
    .task-content {
      flex: 1;
      min-width: 0;
      cursor: text;
    }
    .task-text {
      word-wrap: break-word;
    }
    .task-text.editing {
      outline: 2px solid #3b82f6;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      background: #2a2a2a;
    }
    .timestamp {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    .task-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-left: 1rem;
    }
    .action-btn {
      color: #6b7280;
      cursor: pointer;
      font-size: 1.15rem;
      transition: all 0.2s ease;
      padding: 0.25rem;
      border-radius: 0.25rem;
    }
    .action-btn:hover { 
      background: #374151;
      transform: scale(1.15);
    }
    .action-btn.start:hover { color: #fbbf24; }
    .action-btn.done:hover { color: #4ade80; }
    .action-btn.cancel:hover { color: #f87171; }
    .action-btn.delete:hover { color: #ef4444; }
    .action-btn.edit:hover { color: #3b82f6; }
    .action-btn.reset:hover { color: #a78bfa; }
    .menu {
      position: absolute;
      display: none;
      background: #2a2a2a;
      border: 1px solid #404040;
      border-radius: 0.5rem;
      z-index: 999;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      overflow: hidden;
      min-width: 180px;
    }
    .menu div {
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .menu div:hover { 
      background: #374151; 
    }
    .menu div.hidden {
      display: none;
    }
    .status-icon {
      display: inline-block;
      margin-right: 0.5rem;
      font-size: 1rem;
    }
    #new-task {
      transition: all 0.2s ease;
    }
    #new-task:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .sort-btn {
      transition: all 0.2s ease;
    }
    .sort-btn:hover {
      background: #3b82f6 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    .sort-btn.bg-green-600:hover {
      background: #16a34a !important;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
    }
    .sort-btn.bg-purple-600:hover {
      background: #9333ea !important;
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
    }
  </style>
</head>
<body class="min-h-screen">

<div class="max-w-4xl mx-auto">
  <div class="flex items-center justify-between mb-8">
    <h2 class="text-4xl font-bold text-gray-100 flex items-center gap-3">
      <span class="text-5xl">üìù</span> Lista de Tareas
    </h2>
    <div class="flex items-center gap-2">
      <button 
        id="export-btn" 
        class="sort-btn px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-500 flex items-center gap-2"
        title="Exportar tareas a JSON"
      >
        <span>üíæ</span> Exportar
      </button>
      <label 
        for="import-input" 
        class="sort-btn px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-500 flex items-center gap-2 cursor-pointer"
        title="Importar tareas desde JSON"
      >
        <span>üì•</span> Importar
      </label>
      <input 
        type="file" 
        id="import-input" 
        accept=".json" 
        style="display: none;"
      >
      <button 
        id="sort-btn" 
        class="sort-btn px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-500 flex items-center gap-2"
      >
        <span>üîÑ</span> Ordenar
      </button>
    </div>
  </div>

  <div id="task-list" class="mb-6 space-y-2"></div>

  <input 
    type="text" 
    id="new-task" 
    placeholder="Escribe una tarea y presiona Enter" 
    class="w-full px-5 py-4 bg-[#2a2a2a] text-gray-100 border border-gray-700 rounded-lg text-base focus:border-blue-500 transition-all"
  >
</div>

<div class="menu" id="context-menu">
  <div class="toggle-start">‚ñ∂Ô∏è Iniciar</div>
  <div class="toggle-done">‚úÖ Completar</div>
  <div class="toggle-cancelled">‚ùå Cancelar</div>
  <div class="reset-status">üîÑ Reset Estado</div>
  <div class="edit-task">‚úèÔ∏è Editar</div>
  <div class="delete-task">üóëÔ∏è Eliminar</div>
</div>

<script>
// Constantes para estados de tareas
const TASK_STATUS = {
  PENDING: "",
  STARTED: "started",
  DONE: "done",
  CANCELLED: "cancelled"
};

// Constantes para metadatos de tareas (punto 8)
const TASK_METADATA = {
  DONE: "@done",
  CANCELLED: "@cancelled",
  STARTED: "@started",
  LASTED: "@Lasted"
};

// Regex para limpiar texto de tareas (reutilizable)
const TASK_METADATA_REGEX = new RegExp(
  `${TASK_METADATA.DONE}.*|${TASK_METADATA.CANCELLED}.*|${TASK_METADATA.STARTED}.*|${TASK_METADATA.LASTED}.*`,
  "g"
);

/**
 * Verifica si localStorage est√° disponible (punto 10)
 * @returns {boolean} true si localStorage est√° disponible
 */
function isLocalStorageAvailable() {
  try {
    const test = "__localStorage_test__";
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch (error) {
    return false;
  }
}

/**
 * Valida que un objeto sea una tarea v√°lida (punto 7)
 * @param {*} task - Objeto a validar
 * @returns {boolean} true si es una tarea v√°lida
 */
function isValidTask(task) {
  if (!task || typeof task !== "object") {
    return false;
  }
  
  // Verificar que tenga la propiedad text y sea string
  if (typeof task.text !== "string") {
    return false;
  }
  
  // Verificar que el status sea v√°lido (si existe)
  if (task.status !== undefined && 
      task.status !== TASK_STATUS.PENDING &&
      task.status !== TASK_STATUS.STARTED &&
      task.status !== TASK_STATUS.DONE &&
      task.status !== TASK_STATUS.CANCELLED &&
      task.status !== null) {
    return false;
  }
  
  // Verificar que startedAt sea Date o null (si existe)
  if (task.startedAt !== undefined && 
      task.startedAt !== null && 
      !(task.startedAt instanceof Date) &&
      typeof task.startedAt !== "string") {
    return false;
  }
  
  return true;
}

/**
 * Valida y limpia el array de tareas (punto 7)
 * @param {Array} tasksArray - Array de tareas a validar
 * @returns {Array} Array de tareas v√°lidas
 */
function validateTasks(tasksArray) {
  if (!Array.isArray(tasksArray)) {
    return [];
  }
  
  return tasksArray.filter(task => {
    const isValid = isValidTask(task);
    if (!isValid) {
      console.warn("Tarea inv√°lida encontrada y filtrada:", task);
    }
    return isValid;
  });
}

// Cargar tareas con manejo de errores y validaci√≥n (puntos 7 y 10)
let tasks = [];
if (isLocalStorageAvailable()) {
  try {
    const storedTasks = localStorage.getItem("tasks");
    if (storedTasks !== null) {
      const parsedTasks = JSON.parse(storedTasks);
      tasks = validateTasks(parsedTasks);
    }
  } catch (error) {
    console.error("Error al cargar tareas desde localStorage:", error);
    tasks = [];
  }
} else {
  console.warn("localStorage no est√° disponible. Las tareas no se guardar√°n.");
}

function saveTasks() {
  if (!isLocalStorageAvailable()) {
    console.warn("localStorage no est√° disponible. No se pueden guardar las tareas.");
    return false;
  }
  
  try {
    localStorage.setItem("tasks", JSON.stringify(tasks));
    return true;
  } catch (error) {
    console.error("Error al guardar tareas en localStorage:", error);
    
    // Manejo espec√≠fico de QuotaExceededError (punto 10)
    if (error.name === "QuotaExceededError") {
      alert("No hay suficiente espacio para guardar las tareas. Intenta eliminar algunas tareas.");
    } else {
      alert("Error al guardar las tareas. Por favor, verifica que localStorage est√© disponible.");
    }
    return false;
  }
}

/**
 * Exporta las tareas a un archivo JSON
 */
function exportTasks() {
  try {
    const dataStr = JSON.stringify(tasks, null, 2);
    const dataBlob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `tareas_${new Date().toISOString().split("T")[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    alert("Tareas exportadas correctamente.");
  } catch (error) {
    console.error("Error al exportar tareas:", error);
    alert("Error al exportar las tareas. Por favor, intenta nuevamente.");
  }
}

/**
 * Importa tareas desde un archivo JSON
 * @param {File} file - Archivo JSON a importar
 */
function importTasks(file) {
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      const validatedTasks = validateTasks(importedData);
      
      if (validatedTasks.length === 0 && importedData.length > 0) {
        alert("El archivo no contiene tareas v√°lidas.");
        return;
      }
      
      if (validatedTasks.length < importedData.length) {
        const invalidCount = importedData.length - validatedTasks.length;
        alert(`Se importaron ${validatedTasks.length} tareas v√°lidas. ${invalidCount} tareas fueron descartadas por ser inv√°lidas.`);
      }
      
      if (validatedTasks.length > 0) {
        const confirmMessage = tasks.length > 0 
          ? `¬øDeseas reemplazar las ${tasks.length} tareas actuales con las ${validatedTasks.length} tareas importadas?\n\nSi cancelas, las tareas se agregar√°n a las existentes.`
          : `¬øDeseas importar ${validatedTasks.length} tareas?`;
        
        if (confirm(confirmMessage)) {
          tasks = validatedTasks;
        } else {
          tasks = tasks.concat(validatedTasks);
        }
        
        saveTasks();
        renderTasks();
        alert(`Tareas importadas correctamente. Total: ${tasks.length} tareas.`);
      }
    } catch (error) {
      console.error("Error al importar tareas:", error);
      alert("Error al importar el archivo. Por favor, verifica que sea un archivo JSON v√°lido.");
    }
  };
  
  reader.onerror = function() {
    alert("Error al leer el archivo. Por favor, intenta nuevamente.");
  };
  
  reader.readAsText(file);
}

/**
 * Limpia el texto de una tarea eliminando metadatos de estado
 * @param {Object} task - Objeto de tarea
 * @returns {string} Texto limpio de la tarea
 */
function cleanTaskText(task) {
  if (!task || !task.text) {
    return "";
  }
  return task.text.replace(TASK_METADATA_REGEX, "").trim();
}

/**
 * Actualiza el estado de una tarea y a√±ade los metadatos correspondientes
 * @param {Object} task - Objeto de tarea a actualizar
 * @param {string} newStatus - Nuevo estado (TASK_STATUS.STARTED, TASK_STATUS.DONE, etc.)
 */
function updateTaskStatus(task, newStatus) {
  if (!task) {
    return;
  }

  const cleanText = cleanTaskText(task);
  task.status = newStatus;

  if (newStatus === TASK_STATUS.STARTED) {
    task.startedAt = new Date();
    task.text = cleanText + ` ${TASK_METADATA.STARTED}(${formatDate()})`;
  } else if (newStatus === TASK_STATUS.DONE) {
    const lasted = task.startedAt ? ` ${TASK_METADATA.LASTED}(${getElapsed(task.startedAt)})` : "";
    task.text = cleanText + ` ${TASK_METADATA.DONE}(${formatDate()})${lasted}`;
  } else if (newStatus === TASK_STATUS.CANCELLED) {
    task.text = cleanText + ` ${TASK_METADATA.CANCELLED}(${formatDate()})`;
  } else if (newStatus === TASK_STATUS.PENDING) {
    task.startedAt = null;
    task.text = cleanText;
  }
}

function formatDate() {
  const now = new Date();
  return now.toLocaleDateString("es-ES") + " " + now.toLocaleTimeString("es-ES");
}

function getElapsed(start) {
  const diff = (new Date() - new Date(start)) / 1000;
  const minutes = Math.floor(diff / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (days > 0) return `${days}d ${hours % 24}h`;
  if (hours > 0) return `${hours}h ${minutes % 60}m`;
  if (minutes > 0) return `${minutes}m`;
  return `${Math.floor(diff)}s`;
}

function getStatusIcon(status) {
  if (status === TASK_STATUS.STARTED) return "‚ñ∂Ô∏è";
  if (status === TASK_STATUS.DONE) return "‚úÖ";
  if (status === TASK_STATUS.CANCELLED) return "‚ùå";
  return "";
}

function sortTasks() {
  const order = { 
    [TASK_STATUS.PENDING]: 0, 
    [TASK_STATUS.STARTED]: 1, 
    [TASK_STATUS.DONE]: 2, 
    [TASK_STATUS.CANCELLED]: 3 
  };
  tasks.sort((a, b) => {
    const statusA = a.status || TASK_STATUS.PENDING;
    const statusB = b.status || TASK_STATUS.PENDING;
    return (order[statusA] || 0) - (order[statusB] || 0);
  });
  saveTasks();
  renderTasks();
}

function editTask(index) {
  if (index < 0 || index >= tasks.length) {
    return;
  }
  const task = tasks[index];
  const taskText = cleanTaskText(task);
  const newText = prompt("Editar tarea:", taskText);
  if (newText !== null && newText.trim() !== "") {
    // Usar constantes en lugar de strings hardcodeados
    const statusPattern = `(${TASK_METADATA.DONE}|${TASK_METADATA.CANCELLED}|${TASK_METADATA.STARTED})`;
    const statusMatch = task.text.match(new RegExp(`${statusPattern}\\(([^)]+)\\)(.*)`));
    if (statusMatch) {
      const metadataTag = statusMatch[1];
      task.text = newText.trim() + " " + metadataTag + "(" + statusMatch[2] + ")" + statusMatch[3];
    } else {
      task.text = newText.trim();
    }
    saveTasks();
    renderTasks();
  }
}

function deleteTask(index) {
  if (index < 0 || index >= tasks.length) {
    return;
  }
  const task = tasks[index];
  const taskText = cleanTaskText(task);
  if (confirm(`¬øEst√°s seguro de eliminar la tarea: "${taskText}"?`)) {
    tasks.splice(index, 1);
    saveTasks();
    renderTasks();
  }
}

function renderTasks() {
  $("#task-list").empty();
  tasks.forEach((task, i) => {
    const statusIcon = getStatusIcon(task.status);
    const taskText = cleanTaskText(task);
    // Usar constantes en lugar de strings hardcodeados
    const statusPattern = `(${TASK_METADATA.DONE}|${TASK_METADATA.CANCELLED}|${TASK_METADATA.STARTED})`;
    const timestamp = task.text.match(new RegExp(`${statusPattern}\\(([^)]+)\\)`));
    const timestampText = timestamp ? timestamp[2] : "";
    const elapsed = task.status === TASK_STATUS.DONE && task.startedAt ? ` ¬∑ Duraci√≥n: ${getElapsed(task.startedAt)}` : "";

    const taskDiv = $("<div>").addClass("task").attr("data-index", i);
    if (task.status === TASK_STATUS.DONE) taskDiv.addClass("done");
    if (task.status === TASK_STATUS.CANCELLED) taskDiv.addClass("cancelled");
    if (task.status === TASK_STATUS.STARTED) taskDiv.addClass("started");

    const contentDiv = $("<div>").addClass("task-content");
    const textDiv = $("<div>").addClass("task-text");
    
    // Correcci√≥n XSS: el icono es seguro (viene de getStatusIcon), pero el texto del usuario debe escaparse
    if (statusIcon) {
      // El icono es seguro porque viene de una funci√≥n que solo retorna emojis fijos
      const iconSpan = $("<span>").addClass("status-icon").html(statusIcon);
      textDiv.append(iconSpan);
      // El texto del usuario se escapa usando .text() para prevenir XSS
      textDiv.append($("<span>").text(taskText));
    } else {
      textDiv.text(taskText);
    }
    contentDiv.append(textDiv);

    if (timestampText || elapsed) {
      const ts = $("<div>").addClass("timestamp").text(timestampText + elapsed);
      contentDiv.append(ts);
    }

    const actionsDiv = $("<div>").addClass("task-actions");

    // L√≥gica de botones seg√∫n el estado
    // Sin iniciar (sin estado): mostrar bot√≥n Iniciar
    if (task.status === TASK_STATUS.PENDING || task.status === null) {
      const startBtn = $("<span>")
        .addClass("action-btn start")
        .text("‚ñ∂Ô∏è")
        .attr("title", "Iniciar")
        .attr("data-index", i);
      actionsDiv.append(startBtn);
    }

    // Iniciada: mostrar bot√≥n Completar
    if (task.status === TASK_STATUS.STARTED) {
      const doneBtn = $("<span>")
        .addClass("action-btn done")
        .text("‚úÖ")
        .attr("title", "Completar")
        .attr("data-index", i);
      actionsDiv.append(doneBtn);
    }

    // Completada o Cancelada: no mostrar botones

    taskDiv.append(contentDiv);
    taskDiv.append(actionsDiv);
    $("#task-list").append(taskDiv);
  });

  $("#task-list").sortable({
    cursor: "move",
    opacity: 0.8,
    update: function() {
      const newTasks = [];
      $(".task").each(function() {
        const index = $(this).data("index");
        if (index >= 0 && index < tasks.length) {
          newTasks.push(tasks[index]);
        }
      });
      tasks = newTasks;
      saveTasks();
      renderTasks();
    }
  });
}

$(document).ready(function() {
  renderTasks();

  $("#new-task").on("keypress", function(e) {
    if (e.key === "Enter" && this.value.trim()) {
      tasks.push({ 
        text: this.value.trim(), 
        status: TASK_STATUS.PENDING, 
        startedAt: null 
      });
      this.value = "";
      saveTasks();
      renderTasks();
    }
  });

  // Bot√≥n ordenar
  $("#sort-btn").click(function() {
    sortTasks();
  });

  // Bot√≥n exportar
  $("#export-btn").click(function() {
    exportTasks();
  });

  // Bot√≥n importar
  $("#import-input").on("change", function(e) {
    const file = e.target.files[0];
    if (file) {
      if (file.type === "application/json" || file.name.endsWith(".json")) {
        importTasks(file);
      } else {
        alert("Por favor, selecciona un archivo JSON v√°lido.");
      }
      // Limpiar el input para permitir importar el mismo archivo nuevamente
      $(this).val("");
    }
  });

  let currentIndex = null;

  // Click derecho - men√∫ contextual
  $("#task-list").on("contextmenu", ".task", function(e) {
    e.preventDefault();
    currentIndex = $(this).data("index");
    let task = tasks[currentIndex];

    // Mostrar/ocultar opciones seg√∫n el estado
    // Iniciar: solo si NO est√° iniciada
    if (task.status === TASK_STATUS.PENDING || task.status === null) {
      $(".toggle-start").removeClass("hidden");
    } else {
      $(".toggle-start").addClass("hidden");
    }

    // Completar: solo si est√° iniciada
    if (task.status === TASK_STATUS.STARTED) {
      $(".toggle-done").removeClass("hidden");
    } else {
      $(".toggle-done").addClass("hidden");
    }

    // Los dem√°s siempre visibles
    $(".toggle-cancelled").removeClass("hidden");
    $(".reset-status").removeClass("hidden");
    $(".edit-task").removeClass("hidden");
    $(".delete-task").removeClass("hidden");

    $("#context-menu").css({ top: e.pageY, left: e.pageX }).show();
  });

  $(document).click(() => $("#context-menu").hide());

  // Botones de acci√≥n directa
  $("#task-list").on("click", ".action-btn.start", function(e) {
    e.stopPropagation();
    const index = $(this).data("index");
    if (index >= 0 && index < tasks.length) {
      const task = tasks[index];
      updateTaskStatus(task, TASK_STATUS.STARTED);
      saveTasks();
      renderTasks();
    }
  });

  $("#task-list").on("click", ".action-btn.done", function(e) {
    e.stopPropagation();
    const index = $(this).data("index");
    if (index >= 0 && index < tasks.length) {
      const task = tasks[index];
      updateTaskStatus(task, TASK_STATUS.DONE);
      saveTasks();
      renderTasks();
    }
  });

  // Men√∫ contextual - opciones
  $(".toggle-start").click(() => {
    if (currentIndex !== null && currentIndex >= 0 && currentIndex < tasks.length) {
      const task = tasks[currentIndex];
      updateTaskStatus(task, TASK_STATUS.STARTED);
      saveTasks();
      renderTasks();
    }
  });

  $(".toggle-done").click(() => {
    if (currentIndex !== null && currentIndex >= 0 && currentIndex < tasks.length) {
      const task = tasks[currentIndex];
      updateTaskStatus(task, TASK_STATUS.DONE);
      saveTasks();
      renderTasks();
    }
  });

  $(".toggle-cancelled").click(() => {
    if (currentIndex !== null && currentIndex >= 0 && currentIndex < tasks.length) {
      const task = tasks[currentIndex];
      updateTaskStatus(task, TASK_STATUS.CANCELLED);
      saveTasks();
      renderTasks();
    }
  });

  $(".reset-status").click(() => {
    if (currentIndex !== null && currentIndex >= 0 && currentIndex < tasks.length) {
      const task = tasks[currentIndex];
      updateTaskStatus(task, TASK_STATUS.PENDING);
      saveTasks();
      renderTasks();
    }
  });

  $(".edit-task").click(() => {
    editTask(currentIndex);
  });

  $(".delete-task").click(() => {
    deleteTask(currentIndex);
  });
});
</script>

</body>
</html>